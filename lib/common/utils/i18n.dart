import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';

import 'package:puked/features/settings/providers/settings_provider.dart';

class I18n {
  final Locale locale;
  I18n(this.locale);

  static const _localizedValues = {
    'en': {
      'app_name': 'Puked',
      'history': 'History',
      'arena': 'Arena',
      'settings': 'Settings',
      'start_trip': 'Start Trip',
      'stop_trip': 'End Trip',
      'calibrate': 'Calibrate',
      'calibrating': 'Calibrating, stay still...',
      'calibrated': 'Calibrated!',
      'calibration_failed': 'Calibration Failed',
      'calibration_failed_desc':
          'Please ensure the vehicle and phone are stationary during calibration.',
      'rapid_accel': 'Rapid Accel',
      'rapid_decel': 'Rapid Decel',
      'rapidAcceleration': 'Rapid Accel',
      'rapidDeceleration': 'Rapid Decel',
      'jerk': 'Jerk',
      'bump': 'Bump',
      'wobble': 'Wobble',
      'manual': 'Manual Mark',
      'recorded_msg': 'Recorded (Last 10s data)',
      'calibration_tip':
          'Please keep the vehicle stationary and the phone fixed',
      'no_trips': 'No trip records',
      'no_data_for_brand': 'No Data',
      'exporting': 'Exporting data...',
      'car_model': 'Car Model',
      'peak_g': 'Peak G',
      'realtime_g': 'Real-time G',
      'longitudinal': 'LONGITUDINAL',
      'lateral': 'LATERAL',
      'trip_summary': 'Trip Summary',
      'total_events': 'Total Events',
      'trajectory_points': 'Trajectory Points',
      'duration': 'Duration',
      'event_list': 'Event List',
      'min': 'min',
      'distance': 'Distance',
      'avg_speed': 'Avg Speed',
      'delete_trips': 'Delete Trips',
      'delete_trips_confirm': 'Are you sure you want to delete {} trips?',
      'cancel': 'Cancel',
      'delete': 'Delete',
      'select_items': 'Select Items',
      'edit': 'Edit',
      'modify_vehicle_info': 'Modify Vehicle Info',
      'vehicle_info': 'Vehicle Info',
      'software_version': 'Software Version',
      'model_hint': 'Enter model (e.g. Model 3)',
      'version_hint': 'Enter version (e.g. v12.5)',
      'skip': 'Skip',
      'save': 'Save',
      'ok': 'OK',
      'my_car': 'My Car',
      'arena_top10_title': 'Comfort TOP10',
      'arena_total_mileage_title': 'Total Mileage',
      'arena_total_mileage_subtitle':
          'Total ADAS mileage submitted across all brands',
      'arena_brand_evolution_title': '{} Version Comfort',
      'arena_details_title': 'Comfort Details',
      'km_per_event': 'Km/incident',
      'km_per_event_long': 'Km between negative experiences',
      'km_per_version_event_long':
          'Average km per negative experience by version',
      'by_brand': 'By Brand',
      'by_version': 'By Version',
      'brand_label': 'Brand: {}',
      'all_versions': 'All Versions',
      'select_brand': 'Select Brand',
      'mileage_label': 'Mileage',
      'trips_count': '{} Trips',
      'events_count': '{} Events',
      'account': 'Account',
      'login': 'Login',
      'logout': 'Logout',
      'login_to_sync': 'Login to sync data and share trips',
      'connected_as': 'Connected as: {}',
      'not_verified': 'Not verified (Tap to verify)',
      'verification_sent': 'Verification email sent',
      'verification_success': 'Verification successful!',
      'language': 'Language',
      'chinese': 'Chinese',
      'english': 'English',
      'pro': 'Pro',
      'upload': 'Upload',
      'submit_trip': 'Submit Trip',
      'submit_trip_confirm':
          'Are you sure you want to submit this trip to Arena?',
      'uploading': 'Uploading...',
      'upload_success': 'Upload successful',
      'upload_failed': 'Upload failed',
      'bulk_upload_confirm':
          'Are you sure you want to submit {} selected trips to Arena?',
      'theme': 'Theme',
      'theme_auto': 'System',
      'theme_light': 'Light',
      'theme_dark': 'Dark',
      'sensitivity': 'Auto-tagging Sensitivity',
      'sensitivity_low': 'Low',
      'sensitivity_medium': 'Medium (Sensitive)',
      'sensitivity_high': 'High (Most Sensitive - Default)',
      'sensitivity_tip':
          'Higher sensitivity means lower acceleration thresholds for auto-tagging events.',
      'about': 'About',
      'current_version': 'Current Version',
      'check_update': 'Check for Update',
      'event_sound': 'Event Sound',
      'event_sound_desc': 'Play sound when a negative event occurs',
      'neg_exp': 'Negative Exp.',
      'unknown': 'Unknown',
      'user': 'User',
      'syncing': 'Syncing cloud status...',
      'sync_complete': 'Sync complete, marked {} trips',
      'no_cloud_records': 'No matching cloud records found',
      'sync_cloud_status': 'Sync upload status',
      'car_cert_banner': 'Verify your car to enable trip uploads',
      'upload_cert_photos': 'Car Certification',
      'upload_hint':
          'Please upload a photo showing your car model and VIN (usually found on the lower driver-side windshield or door pillar).',
      'file_limit_hint': 'Up to 3 photos (JPG/PNG, < 5MB each)',
      'submit_for_audit': 'Submit for Verification',
      'submit_success_tip':
          'Verification details submitted! We\'ll review them shortly.',
      'error_image_limit': 'Please select up to 3 photos.',
      'error_image_size': 'Each photo must be under 5MB.',
      'error_image_type': 'Only JPG and PNG photos are supported.',
      'unverified': 'Unverified',
      'pending': 'Pending',
      'approved': 'Approved',
      'rejected': 'Rejected',
      'car_cert_banner_approved':
          'Certified. To modify vehicle info, please resubmit for verification.',
      'car_cert_banner_pending':
          'Verification details submitted, please do not resubmit.',
      'car_cert_banner_rejected':
          'Verification failed, please resubmit information as required.',
      'upload_cert_photos_new': 'Upload Vehicle Info',
      'upload_cert_photos_submitted': 'Vehicle info submitted',
      'upload_hint_new':
          'Please upload App screenshots or photos containing user information and vehicle VIN number.',
      'delete_event_title': 'Confirm Delete Event',
      'delete_event_desc': 'Deleted events cannot be recovered. Are you sure?',
      'privacy_policy': 'Privacy Policy',
      'gps_strong': 'Strong',
      'gps_fair': 'Fair',
      'gps_weak': 'Weak',
      'gps_no_signal': 'No Signal',
      'saving_image': 'Saving as image...',
      'save_success': 'Image saved to gallery',
      'save_failed': 'Failed to save image',
      'share_card': 'Share Card',
      'trip_analysis': 'Trip Analysis',
      'event_breakdown': 'Event Breakdown',
      'error_no_photo_permission': 'Please grant photo gallery permission',
    },
    'zh': {
      'app_name': '吐槽',
      'history': '历史行程',
      'arena': 'Arena',
      'settings': '设置',
      'start_trip': '开始行程',
      'stop_trip': '结束行程',
      'calibrate': '传感器校准',
      'calibrating': '校准中，请保持手机静止...',
      'calibrated': '校准完成！',
      'calibration_failed': '校准失败',
      'calibration_failed_desc': '请确保校准时车辆和手机处于静止状态。',
      'rapid_accel': '急加速',
      'rapid_decel': '急刹',
      'jerk': '顿挫',
      'rapidAcceleration': '急加速',
      'rapidDeceleration': '急刹',
      'jerk_event': '顿挫',
      'bump': '颠簸',
      'wobble': '摆动',
      'manual': '手动标记',
      'recorded_msg': '已记录 (包含过去10秒数据)',
      'calibration_tip': '请保持车辆静止，手机已固定',
      'no_trips': '暂无行程记录',
      'no_data_for_brand': '暂无数据',
      'exporting': '正在导出数据...',
      'car_model': '车型',
      'peak_g': '峰值 G',
      'realtime_g': '实时 G',
      'neg_exp': '负体验',
      'longitudinal': '纵向加速度',
      'lateral': '横向加速度',
      'trip_summary': '行程摘要',
      'total_events': '事件总数',
      'trajectory_points': '轨迹点',
      'duration': '持续时间',
      'event_list': '事件列表',
      'min': '分钟',
      'distance': '行驶里程',
      'avg_speed': '平均车速',
      'delete_trips': '删除行程',
      'delete_trips_confirm': '确定要删除这 {} 条行程吗？',
      'cancel': '取消',
      'delete': '删除',
      'select_items': '选择项目',
      'edit': '编辑',
      'modify_vehicle_info': '修改车辆信息',
      'vehicle_info': '车辆信息',
      'software_version': '软件版本',
      'model_hint': '输入车型 (如 Model 3)',
      'version_hint': '输入软件版本 (如 v12.5)',
      'skip': '跳过',
      'save': '保存',
      'ok': '确定',
      'my_car': '我的爱车',
      'arena_top10_title': '舒适度 TOP10',
      'arena_total_mileage_title': '总里程',
      'arena_total_mileage_subtitle': '目前所有品牌提交的智能驾驶里程',
      'arena_brand_evolution_title': '{} 版本舒适度',
      'arena_details_title': '症状分布',
      'km_per_event': '公里/次',
      'km_per_event_long': '平均发生一次负体验的公里数',
      'km_per_version_event_long': '每个软件版本平均发生一次负体验的公里数',
      'by_brand': '按品牌',
      'by_version': '分版本',
      'brand_label': '品牌: {}',
      'all_versions': '全版本',
      'select_brand': '选择品牌',
      'mileage_label': '累计里程',
      'trips_count': '{} 行程历史',
      'events_count': '{} 次体验',
      'account': '账号',
      'login': '登录',
      'logout': '退出登录',
      'login_to_sync': '登录以同步数据并分享行程',
      'connected_as': '已连接为: {}',
      'not_verified': '账号未验证 (点击验证)',
      'verification_sent': '验证邮件已发送',
      'verification_success': '验证成功！',
      'language': '语言',
      'chinese': '中文',
      'english': '英文',
      'pro': 'Pro',
      'upload': '上传',
      'submit_trip': '提交行程',
      'submit_trip_confirm': '是否确认提交当前行程到 Arena？',
      'uploading': '正在上传...',
      'upload_success': '上传成功',
      'upload_failed': '上传失败',
      'bulk_upload_confirm': '是否确认将选中的 {} 个行程提交到 Arena？',
      'theme': '主题',
      'theme_auto': '跟随系统',
      'theme_light': '白天模式',
      'theme_dark': '夜间模式',
      'sensitivity': '自动打标敏感度',
      'sensitivity_low': '低',
      'sensitivity_medium': '中 (更灵敏)',
      'sensitivity_high': '高 (最灵敏, 默认)',
      'sensitivity_tip': '敏感度越高，触发急加速、急刹车等事件所需的加速度阈值就越小。',
      'about': '关于',
      'current_version': '当前版本',
      'check_update': '检查更新',
      'event_sound': '负体验音效',
      'event_sound_desc': '发生急加速、急减速等事件时播放提示音',
      'unknown': '未知',
      'user': '用户',
      'syncing': '同步云端状态中...',
      'sync_complete': '同步完成，已标记 {} 条行程',
      'no_cloud_records': '云端没有找到相关记录',
      'sync_cloud_status': '同步上传状态',
      'car_cert_banner': '完成爱车认证，开启行程提交功能',
      'upload_cert_photos': '爱车认证',
      'upload_hint': '请上传包含车牌号或 VIN 码的照片（通常在挡风玻璃左下角或车门柱上）',
      'file_limit_hint': '最多 3 张，支持 JPG/PNG，单张 < 5MB',
      'submit_for_audit': '提交认证',
      'submit_success_tip': '认证资料已提交，我们会尽快完成审核。',
      'error_image_limit': '最多只能选择 3 张照片',
      'error_image_size': '单张照片不能超过 5MB',
      'error_image_type': '仅支持 JPG 或 PNG 格式照片',
      'unverified': '未认证',
      'pending': '认证中',
      'approved': '已认证',
      'rejected': '认证失败',
      'car_cert_banner_approved': '已完成认证，如需修改车型信息，请再次提交信息。',
      'car_cert_banner_pending': '认证资料已提交，请勿重复提交',
      'car_cert_banner_rejected': '认证失败，请重新按照要求提交认证信息',
      'upload_cert_photos_new': '上传车辆信息',
      'upload_cert_photos_submitted': '车辆信息已提交',
      'upload_hint_new': '请上传包含用户名信息，车辆VIN号的App截屏或照片',
      'delete_event_title': '确认删除事件',
      'delete_event_desc': '删除后无法恢复，请确认删除么？',
      'privacy_policy': '隐私政策',
      'gps_strong': '强',
      'gps_fair': '中',
      'gps_weak': '弱',
      'gps_no_signal': '无信号',
      'saving_image': '正在保存为图片...',
      'save_success': '图片已保存至相册',
      'save_failed': '保存图片失败',
      'share_card': '生成分享卡片',
      'trip_analysis': '行程数据分析',
      'event_breakdown': '负体验分布',
      'error_no_photo_permission': '请开启相册访问权限',
    },
  };

  String t(String key, {List<String>? args}) {
    // 兼容 zh-CN, en-US 等格式，只取前两个字符
    final lang = locale.languageCode.split('-')[0].split('_')[0];
    String value = _localizedValues[lang]?[key] ?? key;
    if (args != null) {
      for (var arg in args) {
        value = value.replaceFirst('{}', arg);
      }
    }
    return value;
  }
}

// 国际化实例 Provider
final i18nProvider = Provider<I18n>((ref) {
  final settings = ref.watch(settingsProvider);
  // settings.locale 在 SettingsNotifier 中已有初始值探测，且加载后非空
  return I18n(settings.locale ?? const Locale('en'));
});
